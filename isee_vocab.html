<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ISEE Vocabulary Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#1b6bff" />
  <!-- Quiz-themed favicon (SVG question mark in gradient circle) -->
  <link
    rel="icon"
    type="image/svg+xml"
    href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" x2="1"><stop stop-color="%23ffb703"/><stop offset="1" stop-color="%231b6bff"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(%23g)" stroke="%23000" stroke-opacity=".06"/><text x="32" y="42" font-size="36" text-anchor="middle" font-family="Segoe UI, Roboto, Arial, sans-serif" fill="%23ffffff" font-weight="800">?</text></svg>' />
  
  <!-- External CSS -->
  <link rel="stylesheet" href="isee_styles.css" />
</head>
<body>
  <header>
    <h1>ISEE Vocabulary Quiz</h1>
  </header>

  <main id="appRoot">
    <!-- Controls -->
    <section class="panel grid" id="controlsSection">
      <div class="controls">
        <div>
          <label for="subsetSel">Number of questions</label>
          <select id="subsetSel">
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="300">300</option>
          </select>
          <div class="hint">Pick how many questions to include (randomized subset).</div>
        </div>
        <div>
          <label for="shuffleChoices">Shuffle choices</label>
          <div class="row" style="padding-top:6px;">
            <input id="shuffleChoices" type="checkbox" />
            <span class="hint">Randomize A‚ÄìD order per question</span>
          </div>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="buildBtn" class="primary">Build quiz</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <div id="status" aria-live="polite">Ready.</div>
        </div>
      </div>
    </section>

    <!-- Quiz -->
    <section id="quizSection" class="panel" style="display:none;">
      <div class="row" style="width:100%;">
        <strong>Progress:</strong>
        <span id="progress">0 / 0</span>
        <span id="scorePill" class="pill" title="Correct so far">Score: 0</span>

        <!-- Graphical score counter -->
        <div id="scoreWrap" class="score-wrap" aria-label="Score progress">
          <div class="score-track" role="img" aria-label="Correct and incorrect progress">
            <span id="barCorrect" class="bar correct" style="width:0;"></span>
            <span id="barIncorrect" class="bar incorrect" style="width:0; left:0;"></span>
          </div>
          <div class="score-legend">
            <span class="legend-item good">‚úì <span id="cntCorrect">0</span></span>
            <span class="legend-item bad">‚úñ <span id="cntIncorrect">0</span></span>
          </div>
        </div>
      </div>

      <div class="quiz-card" id="quizCard">
        <div class="q-meta" id="qMeta"></div>
        <div class="q-word" id="qWord"></div>
        <div class="choices" id="choices"></div>
        <div id="feedback" class="feedback" aria-live="polite"></div>

        <div class="actions">
          <button id="submitBtn" class="primary">Submit</button>
          <button id="nextBtn" class="ghost" style="display:none;">Next</button>
          <span class="pill" id="qIdPill"></span>
        </div>
      </div>
    </section>

    <!-- Summary -->
    <section id="summarySection" class="panel" style="display:none;">
      <h3>Quiz summary</h3>
      <div class="summary">
        <div><strong>Total questions:</strong> <span id="sumTotal">0</span></div>
        <div><strong>Correct:</strong> <span id="sumCorrect">0</span></div>
        <div><strong>Incorrect:</strong> <span id="sumIncorrect">0</span></div>
        <div><strong>Accuracy:</strong> <span id="sumAcc">0%</span></div>
      </div>
      <p class="hint">Click "Build quiz" to choose a different number and reshuffle.</p>
    </section>

    <!-- Incorrect answers panel -->
    <section id="incorrectPanel" class="panel incorrect-panel" style="display:none;">
      <h4>Incorrect answers</h4>
      <p class="hint">Review the words you missed and their definitions.</p>
      <ul id="incorrectList" class="incorrect-list" aria-live="polite"></ul>
    </section>
  </main>

  <!-- Celebration visuals -->
  <canvas id="confettiCanvas" class="confetti" style="display:none;"></canvas>
  <div id="celebrationBadge" class="celebration-badge" style="display:none;" aria-hidden="true">üèÜ</div>

  <!-- Load data first (classic script, same folder) -->
  <script src="isee_vocab_data.js"></script>

  <!-- App logic -->
  <script>
    // ===== Analytics Configuration =====
    const ANALYTICS_URL = 'https://script.google.com/macros/s/AKfycbzV0b9NopBpxtUwcj9r6kfCp48mo324TEzwc7HtRh4Fj0pSNGX_Ekm3tPqcIqFPxPq7/exec'; // Replace with your deployed web app URL
    const SESSION_ID = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    let quizStartTime = null;

    // ===== Analytics Functions =====
    function sendAnalytics(eventData) {
      if (!ANALYTICS_URL || ANALYTICS_URL.includes('YOUR_GOOGLE_APPS_SCRIPT')) {
        console.log('Analytics not configured. Event:', eventData);
        return;
      }

      const data = {
        ...eventData,
        sessionId: SESSION_ID,
        userAgent: navigator.userAgent,
        referrer: document.referrer,
        timestamp: new Date().toISOString()
      };

      fetch(ANALYTICS_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      }).catch(error => {
        console.error('Analytics error:', error);
      });
    }

    function trackQuizStart(numQuestions, shuffleChoices) {
      quizStartTime = Date.now();
      sendAnalytics({
        event: 'quiz_start',
        numQuestions: numQuestions,
        shuffleChoices: shuffleChoices
      });
    }

    function trackQuestionAnswer(questionNumber, word, correct, selectedAnswer, correctAnswer) {
      sendAnalytics({
        event: 'question_answer',
        questionNumber: questionNumber,
        word: word,
        correct: correct,
        selectedAnswer: selectedAnswer,
        correctAnswer: correctAnswer
      });
    }

    function trackQuizComplete(numQuestions, shuffleChoices, score, accuracy) {
      const timeSpent = quizStartTime ? Math.round((Date.now() - quizStartTime) / 1000) : 0;
      sendAnalytics({
        event: 'quiz_complete',
        numQuestions: numQuestions,
        shuffleChoices: shuffleChoices,
        score: score,
        accuracy: accuracy,
        timeSpent: timeSpent,
        questionsAnswered: numQuestions
      });
    }

    // ===== Utilities =====
    const app = document.getElementById('appRoot');
    const $ = (sel) => app.querySelector(sel);
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ===== Elements (scoped to appRoot) =====
    const subsetSel = $("#subsetSel");
    const statusEl = $("#status");
    const quizSection = $("#quizSection");
    const summarySection = $("#summarySection");
    const incorrectPanel = $("#incorrectPanel");
    const incorrectList = $("#incorrectList");

    const qMeta = $("#qMeta");
    const qWord = $("#qWord");
    const choicesEl = $("#choices");
    const feedbackEl = $("#feedback");
    const progressEl = $("#progress");
    const scorePill = $("#scorePill");
    const qIdPill = $("#qIdPill");
    const buildBtn = $("#buildBtn");
    const submitBtn = $("#submitBtn");
    const nextBtn = $("#nextBtn");
    const sumTotal = $("#sumTotal");
    const sumCorrect = $("#sumCorrect");
    const sumIncorrect = $("#sumIncorrect");
    const sumAcc = $("#sumAcc");

    // Graphical score
    const barCorrect = $("#barCorrect");
    const barIncorrect = $("#barIncorrect");
    const cntCorrect = $("#cntCorrect");
    const cntIncorrect = $("#cntIncorrect");
    const confettiCanvas = document.getElementById("confettiCanvas");
    const celebrationBadge = document.getElementById("celebrationBadge");

    // ===== State =====
    let QUIZ = [];
    let idx = 0;
    let score = 0;
    let answered = new Map();   // number -> { selected, correct }
    let choiceOrder = {};       // number -> ['A','B','C','D']

    // ===== Score UI =====
    function updateScoreUI() {
      const totalDone = answered.size;
      const correctSoFar = Array.from(answered.values()).filter(a => a.correct).length;
      const incorrectSoFar = totalDone - correctSoFar;

      const total = QUIZ.length || 1;
      const pCorrect = (correctSoFar / total) * 100;
      const pIncorrect = (incorrectSoFar / total) * 100;

      barCorrect.style.width = pCorrect + "%";
      barIncorrect.style.width = pIncorrect + "%";
      barIncorrect.style.left = pCorrect + "%";

      cntCorrect.textContent = correctSoFar;
      cntIncorrect.textContent = incorrectSoFar;
    }

    // ===== Celebration =====
    function launchCelebration(durationMs = 5000) {
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
      confettiCanvas.style.display = "block";
      celebrationBadge.style.display = "grid";

      const ctx = confettiCanvas.getContext("2d");
      const colors = ["#ff5a5f","#ffb703","#03d387","#1b6bff","#9b5de5","#00bbf9"];
      const pieces = Array.from({length: 200}, () => ({
        x: Math.random() * window.innerWidth,
        y: -20 - Math.random() * 100,
        r: 5 + Math.random() * 7,
        c: colors[Math.floor(Math.random() * colors.length)],
        vy: 2 + Math.random() * 3.5,
        vx: -1 + Math.random() * 2,
        rot: Math.random() * Math.PI,
        vr: -0.2 + Math.random() * 0.4
      }));

      function resize() {
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
      }

      let confettiTimer;
      function draw() {
        const w = confettiCanvas.width, h = confettiCanvas.height;
        ctx.clearRect(0, 0, w, h);
        pieces.forEach(p => {
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;
          if (p.y > h + 20) { p.y = -20; p.x = Math.random() * w; }
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = p.c;
          ctx.fillRect(-p.r, -p.r/2, p.r*2, p.r);
          ctx.restore();
        });
        confettiTimer = requestAnimationFrame(draw);
      }
      draw();

      setTimeout(() => {
        cancelAnimationFrame(confettiTimer);
        confettiCanvas.style.display = "none";
        celebrationBadge.style.display = "none";
      }, durationMs);

      window.addEventListener("resize", resize, { once: true });
    }

    // ===== Core logic =====
    function buildQuiz() {
      // Ensure QUESTIONS is present (populated by isee_vocab_data.js)
      if (typeof window.QUESTIONS === "undefined" || !Array.isArray(window.QUESTIONS) || !window.QUESTIONS.length) {
        statusEl.innerHTML = '<span class="bad">No QUESTIONS found. Ensure isee_vocab_data.js is loaded before this script.</span>';
        return;
      }

      const size = parseInt(subsetSel.value, 10) || 300;
      const shuffleChoices = $("#shuffleChoices").checked;

      const pool = window.QUESTIONS.slice();
      shuffle(pool);
      QUIZ = pool.slice(0, Math.min(size, pool.length));

      idx = 0; score = 0; answered.clear(); choiceOrder = {};
      quizSection.style.display = "";
      summarySection.style.display = "none";
      incorrectPanel.style.display = "none";
      incorrectList.innerHTML = "";

      const picked = QUIZ.length;
      const total = window.QUESTIONS.length;
      statusEl.innerHTML = `<span class="good">Using ${picked} question(s) out of ${total}. Randomized order.</span>`;

      // Track quiz start
      trackQuizStart(picked, shuffleChoices);

      renderQuestion();
    }

    function renderQuestion() {
      const total = QUIZ.length;
      if (idx < 0) idx = 0;
      if (idx >= total) { showSummary(); return; }

      const q = QUIZ[idx];
      progressEl.textContent = `${idx + 1} / ${total}`;
      scorePill.textContent = `Score: ${score}`;
      qMeta.textContent = `Question ${q.number}`;
      qWord.textContent = `${q.word}`;
      qIdPill.textContent = `ID: ${q.number}`;
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";

      // Hide Next until submit unless already answered
      nextBtn.style.display = "none";

      // Stable per-question order; optionally shuffle
      const letters = ['A','B','C','D'];
      const doShuffleChoices = $("#shuffleChoices").checked;
      let order = choiceOrder[q.number];
      if (!order) {
        order = letters.slice();
        if (doShuffleChoices) shuffle(order);
        choiceOrder[q.number] = order;
      }

      // Render choices
      choicesEl.innerHTML = "";
      order.forEach(letter => {
        const wrap = document.createElement("label");
        wrap.className = "choice";
        const input = document.createElement("input");
        input.type = "radio";
        input.name = "choice";
        input.value = letter;
        input.setAttribute("aria-label", `${letter}) ${q.choices[letter]}`);
        const text = document.createElement("span");
        text.textContent = `${letter}) ${q.choices[letter]}`;
        wrap.appendChild(input);
        wrap.appendChild(text);
        choicesEl.appendChild(wrap);
      });

      // If already answered earlier, show nav and keep Submit hidden
      if (answered.has(q.number)) {
        submitBtn.style.display = "none";
        nextBtn.style.display = "";

        // Keep the prior selection visible and disable all radios
        const prev = answered.get(q.number);
        Array.from(choicesEl.querySelectorAll('input[name="choice"]')).forEach(i => {
          i.checked = (i.value === prev.selected);
          i.disabled = true;
        });

        // Re-apply choice outlines for correct/incorrect visual
        Array.from(choicesEl.querySelectorAll('.choice')).forEach(label => {
          const input = label.querySelector('input');
          label.style.outline = '';
          if (input.value === q.answer) label.style.outline = `3px solid var(--accent-green)`;
          if (input.value === prev.selected && prev.selected !== q.answer) label.style.outline = `3px solid var(--accent-red)`;
        });
      } else {
        submitBtn.style.display = "";
      }

      updateScoreUI();
    }

    function submitCurrent() {
      if (!QUIZ.length) return;

      const q = QUIZ[idx];
      const selected = Array.from(app.querySelectorAll('input[name="choice"]')).find(i => i.checked)?.value;
      if (!selected) {
        feedbackEl.textContent = "Please select an answer.";
        feedbackEl.className = "feedback incorrect";
        return;
      }
      const correct = (selected === q.answer);
      if (!answered.has(q.number)) {
        answered.set(q.number, { selected, correct });
        if (correct) score++;
        
        // Track question answer
        trackQuestionAnswer(q.number, q.word, correct, selected, q.answer);
      }

      feedbackEl.className = "feedback " + (correct ? "correct" : "incorrect");
      if (correct) {
        feedbackEl.textContent = "Correct!";
      } else {
        const correctText = q.choices[q.answer];
        feedbackEl.innerHTML = `Incorrect. Correct answer: ${q.answer}) ${correctText}`;
      }

      // Append definition if available WITH example highlighting
      const defs = window.DEFINITIONS || {};
      const defRaw = (defs[q.word] || defs[q.word?.toUpperCase()] || "").trim?.() || "";
      if (defRaw) {
        const defNode = document.createElement("div");
        defNode.className = "hint def-example";

        // Split on em dash "‚Äì Example:"
        const parts = defRaw.split(/‚Äì\s*Example:\s*/i);
        if (parts.length === 2) {
          const baseDef = parts[0];
          const example = parts[1];

          // Highlight base word and simple variants (e.g., devour, devoured, devouring, devours)
          const base = String(q.word || "").toLowerCase();
          const highlightedExample = example.replace(
            new RegExp(`\\b(${base}\\w*)\\b`, "gi"),
            '<mark>$1</mark>'
          );

          defNode.innerHTML = `Definition: ${baseDef} ‚Äì Example: ${highlightedExample}`;
        } else {
          // Fallback if Example portion not present
          defNode.textContent = `Definition: ${defRaw}`;
        }

        feedbackEl.appendChild(defNode);
      }

      // Highlight choice outlines (brighter colors)
      Array.from(choicesEl.querySelectorAll('.choice')).forEach(label => {
        const input = label.querySelector('input');
        label.style.outline = '';
        if (input.value === q.answer) label.style.outline = '3px solid var(--accent-green)';
        if (input.value === selected && selected !== q.answer) label.style.outline = '3px solid var(--accent-red)';
      });

      // Disable all radio inputs after submission
      Array.from(app.querySelectorAll('input[name="choice"]')).forEach(i => { i.disabled = true; });

      // Update score pill + pulse
      scorePill.textContent = `Score: ${score}`;
      scorePill.classList.remove("pulse");
      void scorePill.offsetWidth;
      scorePill.classList.add("pulse");

      updateScoreUI();

      // After submit: hide Submit, show Next
      submitBtn.style.display = "none";
      nextBtn.style.display = "";
    }

    function showSummary() {
      quizSection.style.display = "none";
      summarySection.style.display = "";

      const total = QUIZ.length;
      const correct = score;
      const incorrect = total - score;
      const accuracy = total ? Math.round((correct/total)*100) : 0;

      sumTotal.textContent = total;
      sumCorrect.textContent = correct;
      sumIncorrect.textContent = incorrect;
      sumAcc.textContent = accuracy + "%";

      // Track quiz completion
      const shuffleChoices = $("#shuffleChoices").checked;
      trackQuizComplete(total, shuffleChoices, correct, accuracy);

      // Build incorrect answers panel
      buildIncorrectPanel();

      // Celebrate
      launchCelebration(6000);
    }

    function buildIncorrectPanel() {
      incorrectList.innerHTML = "";
      const defs = window.DEFINITIONS || {};

      // Collect incorrect in order of appearance in the quiz
      const incorrectItems = QUIZ.filter(q => {
        const a = answered.get(q.number);
        return a && a.correct === false;
      });

      if (!incorrectItems.length) {
        incorrectPanel.style.display = "";
        const li = document.createElement('li');
        li.className = "incorrect-item empty-state";
        li.textContent = "Great job ‚Äì no missed words!";
        incorrectList.appendChild(li);
        return;
      }

      incorrectItems.forEach(q => {
        const li = document.createElement('li');
        li.className = "incorrect-item";

        const word = document.createElement('div');
        word.className = "incorrect-word";
        word.textContent = q.word;

        // Build definition with highlighted example in the incorrect list
        const defTextRaw = (defs[q.word] || defs[q.word?.toUpperCase()] || "").trim?.() || "";
        const def = document.createElement('div');
        def.className = "incorrect-def def-example";

        if (defTextRaw) {
          const parts = defTextRaw.split(/‚Äì\s*Example:\s*/i);
          if (parts.length === 2) {
            const baseDef = parts[0];
            const example = parts[1];

            // Highlight base word and simple variants
            const base = String(q.word || "").toLowerCase();
            const highlightedExample = example.replace(
              new RegExp(`\\b(${base}\\w*)\\b`, "gi"),
              '<mark>$1</mark>'
            );

            def.innerHTML = `Definition: ${baseDef} ‚Äì Example: ${highlightedExample}`;
          } else {
            def.textContent = `Definition: ${defTextRaw}`;
          }
        } else {
          def.textContent = "Definition: (not available)";
        }

        li.appendChild(word);
        li.appendChild(def);
        incorrectList.appendChild(li);
      });

      incorrectPanel.style.display = "";
    }

    // ===== Events =====
    nextBtn.addEventListener("click", () => { idx++; renderQuestion(); });
    submitBtn.addEventListener("click", submitCurrent);
    buildBtn.addEventListener("click", buildQuiz);
  </script>
</body>
</html>
